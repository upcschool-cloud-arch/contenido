# Declarative advantages

This laboratory creates a VPC with up to three public subnets and a security group,
just like the one defined by the [imperative lab](../lab10-imperative/). But in this case,
we are using `terraform` to facilitate the evolution of the infrastructure.

* The [providers.tf](src/providers.tf) file contains a reference to the 
[official AWS provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs).
* The [main.tf](src/main.tf) file lists all the resources managed by this project.

## Exploring the configuration

Look at [main.tf](src/main.tf) and check the following blocks:

* A [data source element](https://developer.hashicorp.com/terraform/language/data-sources), that will query AWS to get the list of Availability Zones of the region.
* Several regular [resources](https://developer.hashicorp.com/terraform/language/resources/syntax), defining individual infrastructure pieces.
* Two resources with a [count loop](https://developer.hashicorp.com/terraform/language/meta-arguments/count), that will generate a list of resources instead of a single one.

The `aws_subnet` collection of resources is specially interesting because if is also
taking advantage of some Terraform functions:

```HCL
resource "aws_subnet" "public" {
  count                   = min(3,length(data.aws_availability_zones.available.names))
  vpc_id                  = aws_vpc.vpc.id
  availability_zone       = data.aws_availability_zones.available.names[count.index]
  cidr_block              = cidrsubnet(aws_vpc.vpc.cidr_block, 8, count.index)
  map_public_ip_on_launch = true

  tags = {
    Name = "${var.prefix}-subnet-public-${data.aws_availability_zones.available.names[count.index]}"
    Tier = "public"
  }
}
```

Invest some time understanding how what `min(3,length(data.aws_availability_zones.available.names))` and `cidrsubnet(aws_vpc.vpc.cidr_block, 8, count.index)` means. You can use the
console to experiment with the functions:

```bash
# 256 possible addresses (32 - (16+8) bits = 8 bits -> 2^8 = 256):

echo 'cidrsubnet("10.0.0.0/16", 8, 0)' | terraform console 
echo 'cidrsubnet("10.0.0.0/16", 8, 1)' | terraform console 
echo 'cidrsubnet("10.0.0.0/16", 8, 2)' | terraform console 

# 16 possible addresses (32 - (16+12) bits = 4 bits -> 2^4 = 16):

echo 'cidrsubnet("10.0.0.0/16", 12, 0)' | terraform console 
echo 'cidrsubnet("10.0.0.0/16", 12, 1)' | terraform console 
echo 'cidrsubnet("10.0.0.0/16", 12, 2)' | terraform console 
```

## Fixing and running the code

Part of the code has been redacted. Use the [online documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc) and your intuition to
fix it.

Once `terraform validate` returns with a success, check the execution plan and
apply the configuration for creating all the infrastructure. Take good note of 
how many individual resources are going to be created.

## Updating the configuration

Edit the main file and change the port opened on the security group to 443. Apply the
update and see how easily we can now update our data center.

Repeat the same process, but this time changing the *CIDR* of the the VPC. What is
happening, in this case?

## Clean up

Remove all the resources generated by the configuration.
